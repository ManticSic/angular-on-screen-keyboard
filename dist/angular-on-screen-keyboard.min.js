angular.module("onScreenKeyboard",["ngSanitize"]).directive("onScreenKeyboard",["$timeout","$document",function(a,b){"use strict";return{restrict:"E",bindToController:!0,controllerAs:"ctrl",scope:{langs:"=?",uppercaseAllWords:"@"},controller:["$sce",function(a){var b=this;b.langs||(b.langs=[[["X","X","X","X",{type:"erase",colspan:2,text:"&lArr;"}],[{type:"margin"},["q","Q","1"],["w","W","2"],["e","E","3"],["r","R","4"],["t","T","5"]],[{type:"caps",colspan:1,text:"caps"},{type:"shift",colspan:1,text:"shift"},{type:"alt",colspan:1,text:"alt"},{type:"lang",colspan:1,text:"lang1"},{type:"space",colspan:2,text:" "}]]]),b.currentLayout=0,b.getText=function(c){var d;return d=angular.isString(c)?b.isAlt?"":b.isUpperCase?c.toUpperCase():c.toLowerCase():angular.isArray(c)?b.isAlt?c[2]?c[2]:"":b.isUpperCase?c[1]?c[1]:"":c[0]?c[0]:"":"margin"===c.type?"":c.text?c.text:b.isAlt?c.alt?c.alt:"":b.isUpperCase?c.upperCase?c.upperCase:"":c.lowerCase?c.lowerCase:"",d&&d.indexOf("&")>-1?a.trustAsHtml(d):d}}],link:function(c,d,e){var f=c.ctrl;f.isUpperCase=!1,f.isCaps=!1,f.isAlt=!1,f.lastInputCtrl=null,f.startPos=null,f.endPos=null,f.printKeyStroke=function(a,b){if(f.lastInputCtrl){if(f.startPos=f.lastInputCtrl.selectionStart,f.endPos=f.lastInputCtrl.selectionEnd,"erase"===a.type)return void f.eraseKeyStroke();if("shift"===a.type)return f.isAlt=!1,f.isUpperCase=!f.isUpperCase,void(f.isCaps=!1);if("caps"===a.type)return f.isAlt=!1,f.isCaps=!f.isCaps,void(f.isUpperCase=!!f.isCaps);if("alt"===a.type)return f.isCaps=!1,f.isUpperCase=!1,void(f.isAlt=!f.isAlt);if("lang"===a.type){var c=f.currentLayout+1;return f.isCaps=!1,f.isUpperCase=!1,f.isAlt=!1,f.isAltLayout=!f.isAltLayout,c>=f.langs.length&&(c=0),void(f.currentLayout=c)}var d=angular.element(b.target||b.srcElement).text(),e=angular.element(f.lastInputCtrl),g=e.val(),h=g.substring(0,f.startPos),i=g.substring(f.endPos,g.length);e.val(h+d+i),e.triggerHandler("change"),f.startPos+=d.length,f.endPos+=d.length,f.lastInputCtrl.selectionStart=f.startPos,f.lastInputCtrl.selectionEnd=f.startPos,f.setKeyboardLayout()}},f.refocus=function(){f.lastInputCtrl.focus()},f.eraseKeyStroke=function(){if(f.lastInputCtrl){var a=f.startPos!==f.endPos,b=angular.element(f.lastInputCtrl),c=b.val(),d=c.substring(0,a?f.startPos:f.startPos-1),e=c.substring(f.endPos,c.length);b.val(d+e),b.triggerHandler("change"),a?f.endPos=f.startPos:(f.startPos--,f.endPos--),f.lastInputCtrl.selectionStart=f.startPos,f.lastInputCtrl.selectionEnd=f.startPos,f.setKeyboardLayout(),f.refocus()}},f.setKeyboardLayout=function(){return f.lastInputCtrl?void(f.isCaps?f.isUpperCase=!0:f.lastInputCtrl.className&&f.isUpperCase?f.isUpperCase=!1:0===angular.element(f.lastInputCtrl).val().length?f.isUpperCase=!0:f.isUpperCase=!1):void(f.isUpperCase=!0)};var g=function(a){var b=a.target||a.srcElement;"INPUT"!==b.tagName&&"TEXTAREA"!==b.tagName||(f.lastInputCtrl=b,f.setKeyboardLayout())},h=function(){f.lastInputCtrl&&(f.startPos=f.lastInputCtrl.selectionStart,f.endPos=f.lastInputCtrl.selectionEnd,f.setKeyboardLayout())};b.bind("focusin",g),b.bind("keyup",h),c.$on("$destroy",function(){b.unbind("focusin",g),b.unbind("keyup",h)}),d.bind("contextmenu",function(a){return a.preventDefault(),!1}),a(function(){f.isUpperCase=!0},0)},templateUrl:"/templates/angular-on-screen-keyboard.html"}}]);;
angular.module('onScreenKeyboard').run(['$templateCache', function($templateCache) {
  'use strict';

  $templateCache.put('/templates/angular-on-screen-keyboard.html',
    "<div class=keyboard><table><tr ng-repeat=\"row in ctrl.langs[ctrl.currentLayout]\"><td ng-repeat=\"key in row track by $index\" ng-click=\"ctrl.printKeyStroke(key, $event)\" colspan=\"{{key.colspan || 1}}\" ng-class=\"{'button': !key.type || key.type !== 'margin',\n" +
    "                           'letter': !key.type || (key.type !== 'margin' && key.type !== 'caps' && key.type !== 'shift' && key.type !== 'space' && key.type !== 'alt' && key.type !== 'lang'),\n" +
    "                           'is-upper': ctrl.isUpperCase,\n" +
    "                           'is-alt': ctrl.isAlt,\n" +
    "                           'is-caps': ctrl.isCaps,\n" +
    "                           'margin': key.type === 'margin',\n" +
    "                           'caps': key.type === 'caps',\n" +
    "                           'shift': key.type === 'shift',\n" +
    "                           'space': key.type === 'space',\n" +
    "                           'alt': key.type === 'alt',\n" +
    "                           'lang': key.type === 'lang',\n" +
    "                           'lang-{{ctrl.currentLayout}}': true}\" class={{key.type}} ng-bind-html=ctrl.getText(key)></td></tr></table></div>"
  );

}]);
